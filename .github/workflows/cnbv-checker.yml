name: Revisor Diario de la CNBV

on:
  # Disparador programado (sin cambios)
  schedule:
    - cron: '0 12 * * *'
  
  # Disparador manual con una nueva opci√≥n
  workflow_dispatch:
    inputs:
      send_test_email:
        description: '‚úÖ Marcar para enviar un correo de prueba ahora'
        required: true
        type: boolean
        default: false

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      # --- PASOS DE CONFIGURACI√ìN (SIN CAMBIOS) ---
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      # --- EJECUCI√ìN DEL SCRIPT (SIN CAMBIOS) ---
      - name: Run CNBV checker script
        run: python check_cnbv.py

      # --- L√ìGICA DE NOTIFICACI√ìN (MEJORADA) ---

      # 1. Revisa si el script encontr√≥ cambios
      - name: Check for file changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain last_headline.txt) ]]; then
            echo "File changed, proceeding to notification."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # 2. Lee el nuevo titular y enlace si hubo cambios
      - name: Read new headline and link
        id: read_file
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          headline=$(head -n 1 last_headline.txt)
          link=$(tail -n 1 last_headline.txt)
          echo "headline=${headline}" >> $GITHUB_OUTPUT
          echo "link=${link}" >> $GITHUB_OUTPUT

      # 3. Env√≠a un correo de ACTUALIZACI√ìN si hubo cambios
      - name: Send Update Email Notification
        if: steps.check_changes.outputs.changed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üö® Nueva Actualizaci√≥n de la CNBV Detectada"
          to: ${{ secrets.MAIL_USERNAME }}
          from: GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>
          body: |
            ¬°Hola!
            Se ha detectado una nueva actualizaci√≥n en la secci√≥n de prensa de la CNBV.

            **Titular:** ${{ steps.read_file.outputs.headline }}

            **Puedes leerla aqu√≠:** ${{ steps.read_file.outputs.link }}

            Este es un mensaje autom√°tico.

      # 4. Env√≠a un correo de PRUEBA si se activ√≥ manualmente
      - name: Send Test Email Notification
        if: github.event.inputs.send_test_email == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Correo de Prueba - Sistema de Notificaci√≥n CNBV"
          to: ${{ secrets.MAIL_USERNAME }}
          from: GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>
          body: |
            ¬°Hola!

            Este es un correo de prueba para confirmar que el sistema de notificaciones por correo est√° funcionando correctamente.

            Tus credenciales y la configuraci√≥n son correctas. El bot est√° listo para vigilar la p√°gina de la CNBV por ti.

            Saludos,
            GitHub Actions Bot

      # 5. Guarda los cambios en el repositorio si hubo una actualizaci√≥n real
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add last_headline.txt
          git commit -m "üìù Actualiza √∫ltimo titular de la CNBV"
          git push
